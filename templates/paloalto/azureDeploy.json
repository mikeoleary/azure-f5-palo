{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01-preview/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "dnsNameForPublicIP": {
            "type": "string",
            "metadata": {
                "description": "Globally unique DNS name to access management interface of VM-Series firewall"
            }
        },
        "dnsNameForPublicIP2": {
            "type": "string",
            "metadata": {
                "description": "Globally unique DNS name to access management interface of VM-Series firewall"
            }
        },
        "vmName": {
            "type": "string",
            "metadata": {
                "description": "Name of VM-Series VM in the Azure portal"
            }
        },
        "vmName2": {
            "type": "string",
            "metadata": {
                "description": "Name of VM-Series VM in the Azure portal"
            }
        },
        "adminUserName": {
            "type": "string",
            "metadata": {
                "description": "Username for VM-Series administrator"
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Password for VM-Series administrator"
            }
        },
        "authenticationType": {
            "type": "string",
            "metadata": {
                "descritpion": "Type of authentication "
            },
            "allowedValues": [
                "sshPublicKey",
                "password"
            ],
            "defaultValue": "password"
        },
        "sshKey": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "SSH RSA public key file as a string."
            }
        },
        "imageVersion": {
            "type": "string",
            "defaultValue": "latest",
            "allowedValues": [
                "8.1.9",
		        "9.1.0",
                "latest"	    
            ],
            "metadata": {
                "description": "PAN-OS version."
            }
        }, 
        "imageSku": {
            "type": "string",
            "defaultValue": "bundle2",
            "allowedValues": [
                "byol",
		        "bundle1",
		        "bundle2"
            ],
            "metadata": {
                "description": "VM-Series model: BYOL or hourly pay-as-you-go (PAYG): Bundle 1 or Bundle 2"
            }
        }, 
        "vmSize": {
            "type": "string",
            "defaultValue": "Standard_DS3_v2",
            "allowedValues": [
                "Standard_D3",
		        "Standard_D3_v2",
                "Standard_DS3_v2",
                "Standard_D4", 
		        "Standard_D4_v2",
		        "Standard_D5",
	        	"Standard_D5_v2",
                "Standard_A4"	    
            ],
            "metadata": {
                "description": "Azure VM size for VM-Series"
            }
        },
	    "availabilitySetName": {
            "type": "string",
	        "defaultValue": "VMSeriesFwAvSet",
            "metadata": {
                "description": "Azure Availability Set for VM-Series firewalls"
            }
        },
        "srcIPInboundNSG": {
            "type": "string",
            "metadata": {
                "description": "Your source public IP address. Added to the restrict inbound DefaultNSG on eth0 (MGMT)"
            },
            "defaultValue": "0.0.0.0/0"
        },
        "baseUrl" : {
	    	"type" : "string",
    		"metadata": {
		    	"artifactsBaseUrl": ""
	    	},
		    "defaultValue": "https://raw.githubusercontent.com/PaloAltoNetworks/azure/master/vmseries-avset"
	    },
        "virtualNetworkAddressPrefix": {
            "type": "string",
            "defaultValue": "10.0.0.0/16",
            "metadata": {
                "description": "Virtual network address CIDR"
            }
        },
        "subnet0Id": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Subnet Id for the Mgmt subnet"
            }
        },
        "subnet1Id": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Subnet Id for the Untrust subnet"
            }
        },
        "subnet2Id": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Subnet Id for the Trust subnet"
            }
        }                  
    },
    "variables": {
        "apiVersion": "2018-10-01",
        "networkApiVersion": "2017-11-01",
        "imagePublisher": "paloaltonetworks",
	    "imageOffer" : "vmseries1",
        "externalLoadBalancerName": "paloalto-ext-alb",
        "extLbId": "[resourceId('Microsoft.Network/loadBalancers',variables('externalLoadBalancerName'))]",
        "fwpublicIPName": "[concat(parameters('vmName'), '-fwMgmtPublicIP')]",
        "fwpublicIPName2": "[concat(parameters('vmName2'), '-fwMgmtPublicIP')]",
        "lbpublicIPName": "paloalto-loadbalancer-publicIP",
        "lbpublicIPId": "[resourceId('Microsoft.Network/publicIPAddresses',variables('lbpublicIPName'))]",
        "location": "[resourceGroup().location]",
        "nicName": "[concat(parameters('vmName'), '-eth')]",
        "nicName2": "[concat(parameters('vmName2'), '-eth')]",
        "publicIPAddressType": "Static",
        "nsgname-mgmt": "[concat(parameters('vmName'), '-DefaultNSG')]",
        "FWPrivateIPAddressUntrust": "10.0.1.10",
        "FWPrivateIPAddressTrust": "10.0.2.10",
        "FWPrivateIPAddressMgmt": "10.0.0.6",
        "FWPrivateIPAddressUntrust2": "10.0.1.11",
        "FWPrivateIPAddressTrust2": "10.0.2.11",
        "FWPrivateIPAddressMgmt2": "10.0.0.7"
    },
    "resources": [
    {
        "apiVersion": "2018-10-01",
        "type": "Microsoft.Compute/availabilitySets",
        "name": "[parameters('availabilitySetName')]",
        "location": "[variables('location')]",
        "properties": {
            "PlatformUpdateDomainCount": 3,
            "PlatformFaultDomainCount": 2
            },
            "sku": {
                "name": "Aligned"
            }
    },
    {
        "apiVersion": "[variables('apiVersion')]",
        "type": "Microsoft.Network/publicIPAddresses",
        "name": "[variables('fwpublicIPName')]",
        "sku": {
            "name": "Standard"
        },
        "location": "[variables('location')]",
        "properties": {
            "publicIPAllocationMethod": "[variables('publicIPAddressType')]",
            "dnsSettings": {
                "domainNameLabel": "[parameters('dnsNameForPublicIP')]"
            }
        }
    }, 
    {
        "apiVersion": "[variables('apiVersion')]",
        "type": "Microsoft.Network/publicIPAddresses",
        "name": "[variables('fwpublicIPName2')]",
        "sku": {
            "name": "Standard"
        },
        "location": "[variables('location')]",
        "properties": {
            "publicIPAllocationMethod": "[variables('publicIPAddressType')]",
            "dnsSettings": {
                "domainNameLabel": "[parameters('dnsNameForPublicIP2')]"
            }
        }
    },
    {
        "apiVersion": "[variables('apiVersion')]",
        "type": "Microsoft.Network/publicIPAddresses",
        "name": "[variables('lbpublicIPName')]",
        "sku": {
            "name": "Standard"
        },
        "location": "[variables('location')]",
        "properties": {
            "publicIPAllocationMethod": "[variables('publicIPAddressType')]"
        }
    }, 
    {
        "apiVersion": "[variables('apiVersion')]",
        "type": "Microsoft.Network/networkSecurityGroups",
        "name": "[concat(parameters('vmName'), '-DefaultNSG')]",
        "location": "[variables('location')]",
        "properties": {
            "securityRules": [{
                "name": "Allow-Outside-From-IP",
                "properties": {
                    "description": "Rule",
                    "protocol": "*",
                    "sourcePortRange": "*",
                    "destinationPortRange": "*",
                    "sourceAddressPrefix": "[parameters('srcIPInboundNSG')]",
                    "destinationAddressPrefix": "*",
                    "access": "Allow",
                    "priority": 100,
                    "direction": "Inbound"
                }
            }, {
                "name": "Allow-Intra",
                "properties": {
                    "description": "Allow intra network traffic",
                    "protocol": "*",
                    "sourcePortRange": "*",
                    "destinationPortRange": "*",
                    "sourceAddressPrefix": "[concat(parameters('virtualNetworkAddressPrefix'))]",
                    "destinationAddressPrefix": "*",
                    "access": "Allow",
                    "priority": 101,
                    "direction": "Inbound"
                }
            }, {
                "name": "Default-Deny",
                "properties": {
                    "description": "Default-Deny if we don't match Allow rule",
                    "protocol": "*",
                    "sourcePortRange": "*",
                    "destinationPortRange": "*",
                    "sourceAddressPrefix": "*",
                    "destinationAddressPrefix": "*",
                    "access": "Deny",
                    "priority": 200,
                    "direction": "Inbound"
                }
            }]
        }
    }, 
    {
        "apiVersion": "[variables('apiVersion')]",
        "type": "Microsoft.Network/networkInterfaces",
        "name": "[concat(variables('nicName'), '0')]",
        "location": "[variables('location')]",
        "dependsOn": [
            "[concat('Microsoft.Network/publicIPAddresses/', variables('fwpublicIPName'))]"
        ],
        "tags": {
            "displayName": "[concat('NetworkInterfaces', '0')]"
        },
        "properties": {
            "ipConfigurations": [{
                "name": "[concat('ipconfig', '0')]",
                "properties": {
                    "privateIPAllocationMethod": "Static",
                    "privateIPAddress": "[variables('FWPrivateIPAddressMgmt')]",
                    "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('fwpublicIPName'))]"
                    },
                    "subnet": {
                        "id": "[parameters('subnet0Id')]"
                    }
                }
            }]
        }
    },
    {
        "apiVersion": "[variables('apiVersion')]",
        "type": "Microsoft.Network/networkInterfaces",
        "name": "[concat(variables('nicName2'), '0')]",
        "location": "[variables('location')]",
        "dependsOn": [
            "[concat('Microsoft.Network/publicIPAddresses/', variables('fwpublicIPName2'))]"
        ],
        "tags": {
            "displayName": "[concat('NetworkInterfaces', '0')]"
        },
        "properties": {
            "ipConfigurations": [{
                "name": "[concat('ipconfig', '0')]",
                "properties": {
                    "privateIPAllocationMethod": "Static",
                    "privateIPAddress": "[variables('FWPrivateIPAddressMgmt2')]",
                    "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('fwpublicIPName2'))]"
                    },
                    "subnet": {
                        "id": "[parameters('subnet0Id')]"
                    }
                }
            }]
        }
    },
    {
        "apiVersion": "[variables('apiVersion')]",
        "type": "Microsoft.Network/networkInterfaces",
        "dependsOn": [
            "[concat('Microsoft.Network/loadBalancers/', variables('externalLoadBalancerName'))]"
        ],
        "name": "[concat(variables('nicName'), '1')]",
        "location": "[variables('location')]",
        "tags": {
            "displayName": "[concat('NetworkInterfaces', '1')]"
        },
        "properties": {
            "enableIPForwarding": true,
            "ipConfigurations": [{
                "name": "[concat('ipconfig', '1')]",
                "properties": {
                    "loadBalancerBackendAddressPools": [
                        {
                            "id": "[concat(variables('extLbId'), '/backendAddressPools/', 'loadBalancerBackEnd')]"
                        }
                    ],
                    "privateIPAllocationMethod": "Static",
                    "privateIPAddress": "[variables('FWPrivateIPAddressUntrust')]",
                    "subnet": {
                        "id": "[parameters('subnet1Id')]"
                    }
                }
            }]
        }
    },
    {
        "apiVersion": "[variables('apiVersion')]",
        "type": "Microsoft.Network/networkInterfaces",
        "dependsOn": [
            "[concat('Microsoft.Network/loadBalancers/', variables('externalLoadBalancerName'))]"
        ],
        "name": "[concat(variables('nicName2'), '1')]",
        "location": "[variables('location')]",
        "tags": {
            "displayName": "[concat('NetworkInterfaces', '1')]"
        },
        "properties": {
            "enableIPForwarding": true,
            "ipConfigurations": [{
                "name": "[concat('ipconfig', '1')]",
                "properties": {
                    "loadBalancerBackendAddressPools": [
                        {
                            "id": "[concat(variables('extLbId'), '/backendAddressPools/', 'loadBalancerBackEnd')]"
                        }
                    ],
                    "privateIPAllocationMethod": "Static",
                    "privateIPAddress": "[variables('FWPrivateIPAddressUntrust2')]",
                    "subnet": {
                        "id": "[parameters('subnet1Id')]"
                    }
                }
            }]
        }
    }, 
    {
        "apiVersion": "[variables('apiVersion')]",
        "type": "Microsoft.Network/networkInterfaces",
        "name": "[concat(variables('nicName'), '2')]",
        "location": "[variables('location')]",
        "tags": {
            "displayName": "[concat('NetworkInterfaces', '2')]"
        },
        "properties": {
            "enableIPForwarding": true,
            "ipConfigurations": [{
                "name": "[concat('ipconfig', '2')]",
                "properties": {
                    "privateIPAllocationMethod": "Static",
                    "privateIPAddress": "[variables('FWPrivateIPAddressTrust')]",
                    "subnet": {
                        "id": "[parameters('subnet2Id')]"
                    }
                }
            }]
        }
    },
    {
        "apiVersion": "[variables('apiVersion')]",
        "type": "Microsoft.Network/networkInterfaces",
        "name": "[concat(variables('nicName2'), '2')]",
        "location": "[variables('location')]",
        "tags": {
            "displayName": "[concat('NetworkInterfaces', '2')]"
        },
        "properties": {
            "enableIPForwarding": true,
            "ipConfigurations": [{
                "name": "[concat('ipconfig', '2')]",
                "properties": {
                    "privateIPAllocationMethod": "Static",
                    "privateIPAddress": "[variables('FWPrivateIPAddressTrust2')]",
                    "subnet": {
                        "id": "[parameters('subnet2Id')]"
                    }
                }
            }]
        }
    },
    {
		"apiVersion": "[variables('apiVersion')]",
		"type": "Microsoft.Compute/virtualMachines",
        "dependsOn": [
         "[concat('Microsoft.Network/networkInterfaces/', variables('nicName'), '0')]",
         "[concat('Microsoft.Network/networkInterfaces/', variables('nicName'), '1')]",
         "[concat('Microsoft.Network/networkInterfaces/', variables('nicName'), '2')]"
        ],
		"name": "[parameters('vmName')]",
		"location": "[variables('location')]",
		"plan": {
			"name": "[parameters('imageSku')]",
			"product": "[variables('imageOffer')]",
			"publisher": "[variables('imagePublisher')]"
		},
		"properties": {
			"availabilitySet": {
				"id": "[resourceId('Microsoft.Compute/availabilitySets',parameters('availabilitySetName'))]"
			},
			"hardwareProfile": {
				"vmSize": "[parameters('vmSize')]"
			},
			"osProfile": {
				"computerName": "[parameters('vmName')]",
				"adminUsername": "[parameters('adminUsername')]",
				"adminPassword": "[parameters('adminPassword')]"
			},
			"storageProfile": {
				"imageReference": {
					"publisher": "[variables('imagePublisher')]",
					"offer": "[variables('imageOffer')]",
					"version": "[parameters('imageVersion')]",
					"sku": "[parameters('imageSku')]"
				},
				"osDisk": {
					"name": "[concat(parameters('vmName'), '-osdisk')]",
					"createOption": "FromImage"
				}
			},
			"networkProfile": {
				"networkInterfaces": [{
					"id": "[resourceId('Microsoft.Network/networkInterfaces',concat(variables('nicName'),'0'))]",
					"properties": {
						"primary": true
					}
				}, {
					"id": "[resourceId('Microsoft.Network/networkInterfaces',concat(variables('nicName'),'1'))]",
					"properties": {
						"primary": false
					}
				}, {
					"id": "[resourceId('Microsoft.Network/networkInterfaces',concat(variables('nicName'),'2'))]",
					"properties": {
						"primary": false
					}
				}]
			}
		}
	},
    {
		"apiVersion": "[variables('apiVersion')]",
		"type": "Microsoft.Compute/virtualMachines",
        "dependsOn": [
         "[concat('Microsoft.Network/networkInterfaces/', variables('nicName2'), '0')]",
         "[concat('Microsoft.Network/networkInterfaces/', variables('nicName2'), '1')]",
         "[concat('Microsoft.Network/networkInterfaces/', variables('nicName2'), '2')]"
        ],
		"name": "[parameters('vmName2')]",
		"location": "[variables('location')]",
		"plan": {
			"name": "[parameters('imageSku')]",
			"product": "[variables('imageOffer')]",
			"publisher": "[variables('imagePublisher')]"
		},
		"properties": {
			"availabilitySet": {
				"id": "[resourceId('Microsoft.Compute/availabilitySets',parameters('availabilitySetName'))]"
			},
			"hardwareProfile": {
				"vmSize": "[parameters('vmSize')]"
			},
			"osProfile": {
				"computerName": "[parameters('vmName')]",
				"adminUsername": "[parameters('adminUsername')]",
				"adminPassword": "[parameters('adminPassword')]"
			},
			"storageProfile": {
				"imageReference": {
					"publisher": "[variables('imagePublisher')]",
					"offer": "[variables('imageOffer')]",
					"version": "[parameters('imageVersion')]",
					"sku": "[parameters('imageSku')]"
				},
				"osDisk": {
					"name": "[concat(parameters('vmName2'), '-osdisk')]",
					"createOption": "FromImage"
				}
			},
			"networkProfile": {
				"networkInterfaces": [{
					"id": "[resourceId('Microsoft.Network/networkInterfaces',concat(variables('nicName2'),'0'))]",
					"properties": {
						"primary": true
					}
				}, {
					"id": "[resourceId('Microsoft.Network/networkInterfaces',concat(variables('nicName2'),'1'))]",
					"properties": {
						"primary": false
					}
				}, {
					"id": "[resourceId('Microsoft.Network/networkInterfaces',concat(variables('nicName2'),'2'))]",
					"properties": {
						"primary": false
					}
				}]
			}
		}
	},
        {
            "apiVersion": "[variables('networkApiVersion')]",
            "location": "[variables('location')]",
            "name": "[variables('externalLoadBalancerName')]",
            "dependsOn": [
                "[concat('Microsoft.Network/publicIpAddresses/', variables('lbpublicIPName'))]"
            ],
            "properties": {
                "backendAddressPools": [
                    {
                        "name": "loadBalancerBackEnd"
                    }
                ],
                "frontendIPConfigurations": [
                    {
                        "name": "loadBalancerFrontEnd1",
                        "properties": {
                            "publicIPAddress": {
                                "id": "[variables('lbpublicIPId')]"
                            }
                        }
                    }
                ],
                "loadBalancingRules": [
                    {
                        "Name": "external-access",
                        "properties": {
                            "backendAddressPool": {
                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('externalLoadBalancerName')), '/backendAddressPools/loadBalancerBackEnd')]"
                            },
                            "backendPort": 443,
                            "frontendIPConfiguration": {
                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('externalLoadBalancerName')), '/frontendIpConfigurations/loadBalancerFrontEnd1')]"
                            },
                            "frontendPort": 443,
                            "idleTimeoutInMinutes": 15,
                            "probe": {
                                "id": "[concat(variables('extLbId'),'/probes/httpsProbe')]"
                            },
                            "protocol": "Tcp"
                        }
                    }
                ],
                "probes": [
                    {
                        "name": "httpsProbe",
                        "properties": {
                            "intervalInSeconds": 15,
                            "numberOfProbes": 3,
                            "port": 443,
                            "protocol": "Tcp"
                        }
                    }
                ]
            },
            "sku": {
                "name": "Standard"
            },
            "type": "Microsoft.Network/loadBalancers"
        }
  ]
}
